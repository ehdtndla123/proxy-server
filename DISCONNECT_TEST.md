# 프록시 단절 테스트 가이드

## 📋 테스트 목적별 방법

### 1️⃣ 정상 종료 테스트 (Graceful Shutdown)

**목적:** 프록시가 정상적으로 종료될 때 클라이언트/서버 반응 확인

**방법:**
```bash
# 방법 1: Ctrl+C
# 프록시 터미널에서 Ctrl+C

# 방법 2: SIGTERM
kill -TERM <프록시_PID>

# 방법 3: 스크립트
./test_disruption.sh
# → 1번 선택
```

**결과:**
- ✅ 프록시가 깔끔하게 종료
- ✅ 로그 파일에 통계 기록
- ✅ 클라이언트와 서버에 FIN 패킷 전송
- ✅ TCP 연결이 정상적으로 닫힌다는 신호

**클라이언트/서버 동작:**
```
recv() 반환값 = 0  (정상 종료)
"Connection closed by peer"
```

---

### 2️⃣ 크래시 시뮬레이션 (Hard Kill)

**목적:** 프록시가 갑자기 죽었을 때 (세그폴트, kill -9 등)

**방법:**
```bash
kill -9 <프록시_PID>

# 또는
./test_disruption.sh
# → 2번 선택
```

**결과:**
- ❌ 프록시 즉시 종료
- ❌ 시그널 핸들러 실행 안 됨
- ❌ 로그 없음
- ❌ 소켓 정리 안 됨
- ⚠️ TCP RST 패킷 발생

**클라이언트/서버 동작:**
```
recv() 반환값 = -1, errno = ECONNRESET
"Connection reset by peer"
```

---

### 3️⃣ 프록시 멈춤 테스트 (Freeze)

**목적:** 프록시가 응답 없이 멈췄을 때 (데드락, 무한루프 등)

**방법:**
```bash
kill -STOP <프록시_PID>

# 또는
./test_disruption.sh
# → 3번 선택
```

**결과:**
- 🔶 프로세스는 살아있음
- 🔶 아무 동작 안 함 (멈춤)
- 🔶 소켓은 열려있지만 데이터 처리 안 됨

**클라이언트/서버 동작:**
```
send() 성공 (TCP 버퍼에 저장)
recv() 블로킹... (응답 없음)
→ 타임아웃 발생!
```

**재개:**
```bash
kill -CONT <프록시_PID>
```

---

### 4️⃣ 특정 연결만 끊기

**목적:** 특정 클라이언트 연결만 끊고 싶을 때

**방법:**
```bash
# 1. 프로세스 확인
ps -eo pid,ppid,cmd | grep tcp_proxy

# 2. 자식 프로세스 PID 확인
# PPID가 부모 PID인 것이 특정 연결

# 3. 해당 PID만 종료
kill -TERM <자식_PID>

# 또는
./test_disruption.sh
# → 7번 선택
```

---

## 🧪 실전 테스트 시나리오

### 시나리오 1: 재연결 테스트

```bash
# 터미널 1: 서버2
./test_server2

# 터미널 2: 프록시
./bin/tcp_proxy -p 9999 -t 127.0.0.1:8080

# 터미널 3: 클라이언트
./test_client 127.0.0.1 9999
> 메시지1

# 터미널 4: 프록시 종료
kill -TERM <프록시_PID>

# 터미널 3에서 확인
> 메시지2
연결 에러 발생!

# 프록시 재시작 후 재연결 테스트
```

---

### 시나리오 2: 타임아웃 테스트

```bash
# 프록시 멈추기
kill -STOP <프록시_PID>

# 클라이언트에서 메시지 전송
> 메시지
(60초 후 타임아웃...)

# 프록시 재개
kill -CONT <프록시_PID>
```

---

### 시나리오 3: 로드 테스트 중 중단

```bash
# 여러 클라이언트 연결
for i in {1..10}; do
    ./test_client 127.0.0.1 9999 &
done

# 연결 상태 확인
./test_disruption.sh → 6번

# 모든 연결 끊기
./test_disruption.sh → 2번
```

---

## 📊 시그널 비교표

| 시그널 | 명령어 | 프로세스 | 소켓 정리 | 로그 | 용도 |
|--------|--------|----------|-----------|------|------|
| SIGTERM | `kill -TERM` | 정상 종료 | ✅ | ✅ | 일반 종료 |
| SIGKILL | `kill -9` | 즉시 종료 | ❌ | ❌ | 강제 종료 |
| SIGSTOP | `kill -STOP` | 일시 정지 | 열린 상태 | ❌ | 멈춤 |
| SIGCONT | `kill -CONT` | 재개 | - | - | 재개 |
| SIGINT | Ctrl+C | 정상 종료 | ✅ | ✅ | 사용자 중단 |

---

## 🔍 연결 상태 확인 방법

### netstat 사용
```bash
netstat -tnp | grep 9999
```

### ss 사용 (더 빠름)
```bash
ss -tnp | grep 9999
```

### 프록시 로그 확인
```bash
tail -f logs/proxy.log
```

---

## 💡 추천 테스트 순서

1. **정상 종료** (Ctrl+C) → 가장 일반적인 케이스
2. **강제 종료** (kill -9) → 크래시 대응
3. **일시 정지** (kill -STOP) → 타임아웃 처리
4. **특정 연결 끊기** → 부분 장애

---

## 🎯 테스트 스크립트 사용법

```bash
./test_disruption.sh
```

메뉴:
- 1: 정상 종료 (SIGTERM)
- 2: 강제 종료 (SIGKILL)
- 3: 일시 정지 (SIGSTOP)
- 4: 재개 (SIGCONT)
- 5: 프로세스 목록
- 6: 연결 상태
- 7: 특정 연결만 끊기

---

## 🐛 디버깅 팁

### 1. 프록시가 안 죽을 때
```bash
# 모든 자식 프로세스까지 강제 종료
killall -9 tcp_proxy
```

### 2. 포트가 안 풀릴 때
```bash
# TIME_WAIT 상태 확인
netstat -tn | grep 9999

# 잠시 기다리거나 SO_REUSEADDR 사용 (이미 적용됨)
```

### 3. 좀비 프로세스
```bash
# 좀비 확인
ps aux | grep defunct

# 부모 프로세스 재시작 (이미 SIGCHLD 처리됨)
```

---

## 📝 테스트 체크리스트

- [ ] Ctrl+C로 정상 종료되는가?
- [ ] kill -9로 강제 종료 시 클라이언트가 에러를 감지하는가?
- [ ] kill -STOP 후 타임아웃이 발생하는가?
- [ ] 여러 클라이언트 중 하나만 끊을 수 있는가?
- [ ] 종료 후 로그 파일에 통계가 기록되는가?
- [ ] 재시작 후 같은 포트로 바로 실행되는가?
